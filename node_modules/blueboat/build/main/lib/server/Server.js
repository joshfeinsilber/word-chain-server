"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const body_parser_1 = __importDefault(require("body-parser"));
const express_1 = __importDefault(require("express"));
const express_basic_auth_1 = __importDefault(require("express-basic-auth"));
const http_1 = require("http");
const socket = __importStar(require("socket.io"));
const socket_io_msgpack_parser_1 = __importDefault(require("socket.io-msgpack-parser"));
const __1 = require("../..");
const GetGameValues_1 = __importDefault(require("../api/GetGameValues"));
const GetRoom_1 = __importDefault(require("../api/GetRoom"));
const GetRooms_1 = __importDefault(require("../api/GetRooms"));
const SetGameValues_1 = __importDefault(require("../api/SetGameValues"));
const PubSubListeners_1 = require("../constants/PubSubListeners");
const bundle_1 = __importDefault(require("../panel/bundle"));
const Logger_1 = __importStar(require("../utils/Logger"));
const ConnectionHandler_1 = __importDefault(require("./Connection/ConnectionHandler"));
const CustomGameValues_1 = __importDefault(require("./CustomGameValues"));
const Emitter_1 = __importDefault(require("./Emitter"));
const RoomFetcher_1 = __importDefault(require("./RoomFetcher"));
const PANEL_PREFIX = '/blueboat-panel';
const PANEL_HTML = `
<html>
<head>
<title>Blueboat Panel</title>
</head>
<div id='root'></div>
<script>
${bundle_1.default.js}
</script>
</html>
`;
const signals = ['SIGINT', 'SIGTERM', 'SIGUSR2', 'uncaughtException'];
class Server {
    constructor(options) {
        this.server = null;
        this.storage = null;
        this.state = {
            availableRoomTypes: [],
            managingRooms: new Map()
        };
        this.listen = null;
        this.initialOptions = null;
        this.app = null;
        this.io = null;
        this.roomFetcher = null;
        this.customRoomIdGenerator = null;
        this.onError = null;
        this.registerRoom = (roomName, handler, options) => {
            const { availableRoomTypes } = this.state;
            if (availableRoomTypes.map(room => room.name).includes(roomName)) {
                // Can't have two handlers for the same room
                return;
            }
            this.state.availableRoomTypes.push({ name: roomName, handler, options });
            return;
        };
        this.getRoomCount = async () => {
            try {
                const rooms = await this.roomFetcher.getListOfRooms();
                return rooms.length;
            }
            catch (e) {
                throw e;
            }
        };
        this.getRooms = async () => {
            try {
                const rooms = await this.roomFetcher.getListOfRoomsWithData();
                return rooms;
            }
            catch (e) {
                throw e;
            }
        };
        this.getNumberOfConnectedClients = () => {
            return new Promise(resolve => {
                this.io.of('/').clients((error, clients) => {
                    if (!error) {
                        resolve(clients.length);
                    }
                    else {
                        resolve(0);
                    }
                });
            });
        };
        this.gracefullyShutdown = () => this.shutdown()
            .then()
            .catch();
        this.onRoomMade = (room) => {
            this.state.managingRooms.set(room.roomId, room);
        };
        this.onRoomDisposed = (roomId) => {
            Logger_1.default(`${roomId} disposed`, Logger_1.LoggerTypes.room);
            this.state.managingRooms.delete(roomId);
        };
        this.spawnServer = (options) => {
            Logger_1.default('Spawning server...', Logger_1.LoggerTypes.server);
            this.server = new http_1.Server(this.app);
            this.makeRoutes(options.admins);
            this.listen = (port, callback) => {
                this.server.listen(port, callback);
                Logger_1.default('Server listening on port ' + port, Logger_1.LoggerTypes.server);
            };
            const socketOptions = {
                // @ts-ignore
                parser: socket_io_msgpack_parser_1.default,
                path: '/blueboat',
                transports: ['websocket'],
                pingTimeout: options.pingTimeout || 5000,
                pingInterval: options.pingInterval || 25000
            };
            this.io = socket.default(socketOptions);
            if (options.adapters && options.adapters.length) {
                options.adapters.forEach(adapter => this.io.adapter(adapter));
            }
            this.io.attach(this.server, socketOptions);
            this.io.on('connection', s => {
                Logger_1.default(s.id + ' connected', Logger_1.LoggerTypes.io);
                ConnectionHandler_1.default({
                    availableRoomTypes: this.state.availableRoomTypes,
                    io: this.io,
                    pubsub: this.pubsub,
                    storage: this.storage,
                    roomFetcher: this.roomFetcher,
                    gameValues: this.gameValues,
                    socket: s,
                    onRoomMade: this.onRoomMade,
                    onRoomDisposed: this.onRoomDisposed,
                    customRoomIdGenerator: this.customRoomIdGenerator
                });
            });
            this.spawnPubSub();
            signals.forEach(signal => process.once(signal, (reason) => this.shutdown(signal, reason)));
        };
        this.spawnPubSub = () => {
            this.pubsub.on(PubSubListeners_1.PLAYER_LEFT, (playerId) => {
                Emitter_1.default.emit(PubSubListeners_1.PLAYER_LEFT, playerId);
            });
        };
        this.makeRoutes = (adminUsers) => {
            const router = express_1.default.Router();
            router.use(body_parser_1.default.json());
            // @ts-ignore
            router.use((req, res, next) => {
                // @ts-ignore
                req.gameServer = this;
                next();
            });
            router.use(express_basic_auth_1.default({ users: adminUsers, challenge: true }));
            // @ts-ignore
            router.get('/', (req, res) => {
                res.send(PANEL_HTML);
            });
            router.get('/rooms', GetRooms_1.default);
            router.get('/rooms/:room', GetRoom_1.default);
            router.get('/gameValues', GetGameValues_1.default);
            router.post('/gameValues', SetGameValues_1.default);
            this.app.use(PANEL_PREFIX, router);
        };
        this.shutdown = async (signal, reason) => {
            if (this.onError) {
                this.onError(signal, reason);
            }
            if (signal === 'uncaughtException' && reason) {
                console.log(reason);
            }
            try {
                if (this.state.managingRooms.size) {
                    await Promise.all(Array.from(this.state.managingRooms.values()).map(room => room
                        .dispose()
                        .then()
                        .catch()));
                }
                if (this.initialOptions && this.initialOptions.onDispose) {
                    await this.initialOptions.onDispose();
                }
                Logger_1.default('Server closing...', Logger_1.LoggerTypes.server);
                this.io.close();
                this.server.close();
            }
            catch (e) {
                Logger_1.default('Server closing...', Logger_1.LoggerTypes.server);
                this.io.close();
                this.server.close();
                return;
            }
        };
        this.initialOptions = options;
        this.app = options.app;
        this.storage = options.storage;
        // @ts-ignore
        this.pubsub = options.pubsub;
        this.roomFetcher = new RoomFetcher_1.default({ storage: this.storage });
        this.gameValues = new CustomGameValues_1.default({
            storage: __1.RedisStorage({ clientOptions: options.redis })
        });
        this.customRoomIdGenerator = options.customRoomIdGenerator;
        if (options.onError) {
            this.onError = options.onError;
        }
        this.spawnServer(options);
    }
}
exports.default = Server;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9zZXJ2ZXIvU2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDhEQUFvQztBQUNwQyxzREFBNkI7QUFDN0IsNEVBQTBDO0FBQzFDLCtCQUEyQztBQUUzQyxrREFBbUM7QUFDbkMsd0ZBQXdEO0FBQ3hELDZCQUFvQztBQUVwQyx5RUFBZ0Q7QUFDaEQsNkRBQW9DO0FBQ3BDLCtEQUFzQztBQUN0Qyx5RUFBZ0Q7QUFDaEQsa0VBQTBEO0FBQzFELDZEQUE4QztBQUk5QywwREFBcUQ7QUFDckQsdUZBQThEO0FBQzlELDBFQUFpRDtBQUNqRCx3REFBK0I7QUFDL0IsZ0VBQXVDO0FBRXZDLE1BQU0sWUFBWSxHQUFHLGlCQUFpQixDQUFBO0FBQ3RDLE1BQU0sVUFBVSxHQUFHOzs7Ozs7O0VBT2pCLGdCQUFnQixDQUFDLEVBQUU7OztDQUdwQixDQUFBO0FBeUJELE1BQU0sT0FBTyxHQUFHLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsbUJBQW1CLENBQUMsQ0FBQTtBQUVyRSxNQUFNLE1BQU07SUFtQlYsWUFBWSxPQUF3QjtRQWxCN0IsV0FBTSxHQUFlLElBQUksQ0FBQTtRQUN6QixZQUFPLEdBQVksSUFBSSxDQUFBO1FBR3ZCLFVBQUssR0FBZ0I7WUFDMUIsa0JBQWtCLEVBQUUsRUFBRTtZQUN0QixhQUFhLEVBQUUsSUFBSSxHQUFHLEVBQUU7U0FDekIsQ0FBQTtRQUNNLFdBQU0sR0FBa0QsSUFBSSxDQUFBO1FBRTNELG1CQUFjLEdBQW9CLElBQUksQ0FBQTtRQUN0QyxRQUFHLEdBQXdCLElBQUksQ0FBQTtRQUMvQixPQUFFLEdBQW9CLElBQUksQ0FBQTtRQUUxQixnQkFBVyxHQUFnQixJQUFJLENBQUE7UUFDL0IsMEJBQXFCLEdBQUcsSUFBSSxDQUFBO1FBQzVCLFlBQU8sR0FBRyxJQUE0QyxDQUFBO1FBbUJ2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