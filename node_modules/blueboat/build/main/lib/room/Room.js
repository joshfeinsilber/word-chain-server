"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const timer_1 = __importDefault(require("@gamestdio/timer"));
const ClientActions_1 = __importDefault(require("../constants/ClientActions"));
const PubSubListeners_1 = require("../constants/PubSubListeners");
const ServerActions_1 = __importDefault(require("../constants/ServerActions"));
const Emitter_1 = __importDefault(require("../server/Emitter"));
const Callback_1 = __importDefault(require("../utils/Callback"));
const Client_1 = __importDefault(require("./Client"));
class Room {
    /* tslint:enable */
    constructor(options) {
        // Public values
        // @ts-ignore
        this.state = {};
        this.initialGameValues = {};
        this.clock = new timer_1.default(true);
        this.clients = [];
        this.options = {};
        this.creatorOptions = {};
        this.listeners = {
            onJoin: new Callback_1.default(),
            onLeave: new Callback_1.default()
        };
        this.disposing = false;
        // @ts-ignore
        this._lastState = {};
        this.setState = (newState) => {
            this.state = newState;
        };
        this.broadcast = (key, data) => {
            this.clients.forEach(client => client.send(key, data));
        };
        this.setMetadata = (newMetadata) => {
            this.roomFetcher
                .setRoomMetadata(this.roomId, newMetadata)
                .then(() => (this.metadata = newMetadata))
                .catch();
        };
        this.dispose = async () => {
            if (this.disposing) {
                return;
            }
            this.disposing = true;
            try {
                await Promise.all(this.clients.map(client => this.removeClient(client.sessionId, true)));
                if (this.beforeDispose) {
                    await this.beforeDispose();
                }
                this.clock.stop();
                await this.roomFetcher.removeRoom(this.roomId);
                if (this._gameMessagePubsub && this._gameMessagePubsub.unsubscribe) {
                    this._gameMessagePubsub.unsubscribe();
                }
                Emitter_1.default.removeListener(PubSubListeners_1.PLAYER_LEFT, this._playerPubsub);
                if (this.onDispose) {
                    await this.onDispose();
                }
                this.onRoomDisposed(this.roomId);
            }
            catch (e) {
                throw e;
            }
        };
        this.allowReconnection = (client, seconds) => {
            return new Promise(resolve => {
                if (this.disposing) {
                    resolve(false);
                    return;
                }
                const timeOut = this.clock.setTimeout(() => {
                    const reconnected = this.clients.filter(c => c.id === client.id).length
                        ? true
                        : false;
                    if (listener) {
                        listener.clear();
                    }
                    resolve(reconnected);
                }, seconds * 1000);
                const listener = this.listeners.onJoin.add((joinedClient) => {
                    const reconnected = this.clients.filter(c => c.id === joinedClient.id)
                        .length
                        ? true
                        : false;
                    if (reconnected) {
                        if (timeOut) {
                            timeOut.clear();
                        }
                        resolve(true);
                        listener.clear();
                    }
                });
            });
        };
        this.onRoomCreated = () => {
            //
        };
        this.findFullClientFromSimpleClient = (simpleClient) => {
            return this.clients.filter(client => client.sessionId === simpleClient.sessionId && client.id === client.id)[0];
        };
        this.addClient = (prejoinedClient, options) => {
            this.clients.push(new Client_1.default(this.roomId, prejoinedClient.id, prejoinedClient.sessionId, prejoinedClient.origin, prejoinedClient.ip, this.io, this.removeClient));
            this.clientHasJoined(this.findFullClientFromSimpleClient(prejoinedClient), options);
        };
        this.clientHasJoined = (client, options) => {
            if (this.owner && this.owner.id && client.id === this.owner.id) {
                this.owner.sessionId = client.sessionId;
            }
            client.send(ServerActions_1.default.joinedRoom);
            if (this.onJoin) {
                this.listeners.onJoin.call(client, options);
                this.onJoin(client, options);
            }
        };
        this.clientRequestsToJoin = async (client, options) => {
            try {
                // Two clients with the same ID are not allowed to join
                if (process.env.BLUEBOAT_NO_SAME_CLIENTS) {
                    if (this.clients.filter(c => c.id === client.id).length) {
                        // tslint:disable-next-line:no-string-throw
                        throw 'ALREADY_IN_ROOM';
                    }
                }
                if (this.canClientJoin) {
                    await this.canClientJoin(client, options);
                }
                return true;
            }
            catch (e) {
                throw e;
            }
        };
        this.removeClient = async (clientSessionId, intentional) => {
            const client = this.clients.filter(c => c.sessionId === clientSessionId)[0];
            if (!client) {
                return;
            }
            client.send(ServerActions_1.default.removedFromRoom);
            this.clients = this.clients.filter(c => c !== client);
            this.listeners.onLeave.call(client, intentional);
            if (this.onLeave) {
                await this.onLeave(client, intentional);
            }
            if (!this.clients || !this.clients.length) {
                this.dispose()
                    .then()
                    .catch();
            }
        };
        this.pubSubListener = () => {
            this._gameMessagePubsub = this.pubsub.on(this.roomId, (d) => {
                const payload = d;
                if (!payload || !payload.action) {
                    return;
                }
                if (payload.action === PubSubListeners_1.REQUEST_INFO) {
                    this.pubsub.publish(PubSubListeners_1.REQUEST_INFO, {
                        clients: this.clients,
                        state: this.state
                    });
                    return;
                }
                if (!payload.client) {
                    return;
                }
                const { action, data, client } = payload;
                if (action === ClientActions_1.default.joinRoom) {
                    this.clientRequestsToJoin(client, data.options)
                        .then(() => {
                        this.addClient(client, data.options);
                    })
                        .catch(e => this.io.to(client.sessionId).emit(`${this.roomId}-error`, e));
                }
                if (action === ClientActions_1.default.sendMessage) {
                    const roomClient = this.clients.filter(c => c.sessionId === payload.client.sessionId)[0];
                    if (!roomClient) {
                        return;
                    }
                    if (this.onMessage) {
                        this.onMessage(roomClient, payload.data.key, payload.data.data);
                    }
                }
            });
            this._playerPubsub = (playerSessionId) => {
                const client = this.clients.filter(c => c.sessionId === playerSessionId)[0];
                if (!client) {
                    return;
                }
                this.removeClient(client.sessionId, false)
                    .then()
                    .catch();
            };
            Emitter_1.default.addListener(PubSubListeners_1.PLAYER_LEFT, this._playerPubsub);
        };
        this.roomId = options.roomId;
        this.io = options.io;
        this.pubsub = options.pubsub;
        this.storage = options.storage;
        this.owner = options.owner;
        this.onRoomDisposed = options.onRoomDisposed;
        this.roomFetcher = options.roomFetcher;
        this.gameValues = options.gameValues;
        this.roomType = options.roomType;
        this.initialGameValues = options.initialGameValues;
        if (options.options) {
            this.options = options.options;
        }
        if (options.creatorOptions) {
            this.creatorOptions = options.creatorOptions;
        }
        const roomCreated = (error) => {
            options.onRoomCreated(error);
            this.onRoomCreated();
            if (error) {
                // @ts-ignore
                this.dispose().catch((e) => false);
            }
        };
        if (this.onCreate) {
            this.onCreate(options.options)
                .then(() => roomCreated())
                .catch(e => roomCreated(e));
        }
        else {
            roomCreated();
        }
        // Dispose room automatically in 2.5 hours
        this.clock.setTimeout(() => this.dispose()
            .then()
            .catch(), 1000 * 60 * 60 * 2.5);
        this.pubSubListener();
    }
}
exports.default = Room;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUm9vbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvcm9vbS9Sb29tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNkRBQW9DO0FBR3BDLCtFQUFzRDtBQUN0RCxrRUFBd0U7QUFDeEUsK0VBQXNEO0FBR3RELGdFQUF1QztBQUd2QyxpRUFBd0M7QUFDeEMsc0RBQTZCO0FBa0I3QixNQUFNLElBQUk7SUFtQ1IsbUJBQW1CO0lBRW5CLFlBQVksT0FBb0I7UUFwQ2hDLGdCQUFnQjtRQUVoQixhQUFhO1FBQ04sVUFBSyxHQUFVLEVBQUUsQ0FBQTtRQUNqQixzQkFBaUIsR0FBUSxFQUFFLENBQUE7UUFFM0IsVUFBSyxHQUFHLElBQUksZUFBSyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3ZCLFlBQU8sR0FBYSxFQUFFLENBQUE7UUFDdEIsWUFBTyxHQUFHLEVBQVMsQ0FBQTtRQUNuQixtQkFBYyxHQUFHLEVBQVMsQ0FBQTtRQU0xQixjQUFTLEdBQUc7WUFDakIsTUFBTSxFQUFFLElBQUksa0JBQVEsRUFBRTtZQUN0QixPQUFPLEVBQUUsSUFBSSxrQkFBUSxFQUFFO1NBQ3hCLENBQUE7UUFVTyxjQUFTLEdBQVksS0FBSyxDQUFBO1FBSWxDLGFBQWE7UUFDTCxlQUFVLEdBQVUsRUFBRSxDQUFBO1FBOER2QixhQUFRLEdBQUcsQ0FBQyxRQUFlLEVBQUUsRUFBRTtZQUNwQyxJQUFJLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQTtRQUN2QixDQUFDLENBQUE7UUFFTSxjQUFTLEdBQUcsQ0FBQyxHQUFXLEVBQUUsSUFBVSxFQUFFLEVBQUU7WUFDN0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO1FBQ3hELENBQUMsQ0FBQTtRQUVNLGdCQUFXLEdBQUcsQ0FBQyxXQUFnQixFQUFF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