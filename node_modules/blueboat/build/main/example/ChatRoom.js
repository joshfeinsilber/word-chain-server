"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../index");
const State_1 = __importDefault(require("./State"));
class ChatRoom extends index_1.Room {
    constructor() {
        super(...arguments);
        this.onLeave = async (client) => {
            const reconnected = await this.allowReconnection(client, 30);
            if (reconnected) {
                return;
            }
            this.addMessage(`${client.id} has left the room`, 'Botsy');
        };
        this.addMessage = (text, senderId) => {
            const message = { message: text, senderId };
            this.state.messages.push(message);
            this.broadcast('MESSAGE', message);
        };
        this.catchUp = (client) => client.send('MESSAGES', this.state.messages);
    }
    async onCreate() {
        try {
            this.setState(new State_1.default(this.initialGameValues.initialBotMessage || 'Welcome to the chat!'));
        }
        catch (e) {
            throw e;
        }
    }
    onJoin(client) {
        this.catchUp(client);
    }
    onMessage(client, action, data) {
        if (!action) {
            return;
        }
        if (action === 'LATENCY') {
            client.send('LATENCY', data);
        }
        if (action === 'CHAT') {
            this.addMessage(data, client.id);
        }
    }
    async beforeDispose() {
        this.broadcast('DISPOSED');
    }
}
exports.default = ChatRoom;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhdFJvb20uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZXhhbXBsZS9DaGF0Um9vbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG9DQUF1QztBQUN2QyxvREFBMkI7QUFFM0IsTUFBTSxRQUFTLFNBQVEsWUFBVztJQUFsQzs7UUFpQ1MsWUFBTyxHQUFHLEtBQUssRUFBRSxNQUFjLEVBQUUsRUFBRTtZQUN4QyxNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDNUQsSUFBSSxXQUFXLEVBQUU7Z0JBQ2YsT0FBTTthQUNQO1lBQ0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxFQUFFLG9CQUFvQixFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQzVELENBQUMsQ0FBQTtRQUVPLGVBQVUsR0FBRyxDQUFDLElBQVksRUFBRSxRQUFnQixFQUFFLEVBQUU7WUFDdEQsTUFBTSxPQUFPLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFBO1lBQzNDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUNqQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUNwQyxDQUFDLENBQUE7UUFFTyxZQUFPLEdBQUcsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUNuQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQ2hELENBQUM7SUFoRFEsS0FBSyxDQUFDLFFBQVE7UUFDbkIsSUFBSTtZQUNGLElBQUksQ0FBQyxRQUFRLENBQ1gsSUFBSSxlQUFLLENBQ1AsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixJQUFJLHNCQUFzQixDQUNuRSxDQUNGLENBQUE7U0FDRjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsTUFBTSxDQUFDLENBQUE7U0FDUjtJQUNILENBQUM7SUFFTSxNQUFNLENBQUMsTUFBYztRQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ3RCLENBQUM7SUFFTSxTQUFTLENBQUMsTUFBYyxFQUFFLE1BQWMsRUFBRSxJQUFVO1FBQ3pELElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFNO1NBQ1A7UUFDRCxJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUE7U0FDN0I7UUFDRCxJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUU7WUFDckIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1NBQ2pDO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxhQUFhO1FBQ3hCLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDNUIsQ0FBQztDQWtCRjtBQUVELGtCQUFlLFFBQVEsQ0FBQSJ9